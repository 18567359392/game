# 数据模型

<cite>
**本文档引用的文件**
- [index.ts](file://civilization-game/src/types/index.ts)
- [game.ts](file://civilization-game/src/stores/game.ts)
- [save.ts](file://civilization-game/src/stores/save.ts)
- [constants.ts](file://civilization-game/src/config/constants.ts)
- [formatNumber.ts](file://civilization-game/src/utils/formatNumber.ts)
- [resources.ts](file://civilization-game/src/config/resources.ts)
- [buildings.ts](file://civilization-game/src/config/buildings.ts)
- [BuildingCard.vue](file://civilization-game/src/components/game/BuildingCard.vue)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构概览](#项目结构概览)
3. [核心数据类型](#核心数据类型)
4. [游戏状态管理](#游戏状态管理)
5. [存档系统设计](#存档系统设计)
6. [大数字处理策略](#大数字处理策略)
7. [类型安全与架构优势](#类型安全与架构优势)
8. [性能优化考虑](#性能优化考虑)
9. [故障排除指南](#故障排除指南)
10. [总结](#总结)

## 简介

本文档详细介绍了文明游戏项目的完整数据模型体系。该系统采用TypeScript构建，通过严格的类型定义确保代码的健壮性和可维护性。数据模型涵盖了从基础资源到复杂科技树的全方位游戏状态管理，支持多时代发展、资源生产和建筑升级等核心机制。

## 项目结构概览

```mermaid
graph TB
subgraph "类型定义层"
Types[index.ts<br/>核心类型定义]
Constants[constants.ts<br/>游戏常量配置]
end
subgraph "配置层"
Resources[resources.ts<br/>资源配置]
Buildings[buildings.ts<br/>建筑配置]
Technologies[technologies.ts<br/>科技配置]
Achievements[achievements.ts<br/>成就配置]
end
subgraph "状态管理层"
GameStore[game.ts<br/>游戏状态]
ResourceStore[resource.ts<br/>资源状态]
BuildingStore[building.ts<br/>建筑状态]
TechStore[tech.ts<br/>科技状态]
SaveStore[save.ts<br/>存档管理]
end
subgraph "组件层"
BuildingCard[BuildingCard.vue<br/>建筑展示组件]
ResourcePanel[ResourcePanel.vue<br/>资源面板组件]
TechTree[TechTree.vue<br/>科技树组件]
end
Types --> GameStore
Types --> ResourceStore
Types --> BuildingStore
Types --> TechStore
Types --> SaveStore
Constants --> Types
Resources --> Types
Buildings --> Types
Technologies --> Types
Achievements --> Types
GameStore --> BuildingCard
ResourceStore --> ResourcePanel
TechStore --> TechTree
```

**图表来源**
- [index.ts](file://civilization-game/src/types/index.ts#L1-L198)
- [game.ts](file://civilization-game/src/stores/game.ts#L1-L50)
- [save.ts](file://civilization-game/src/stores/save.ts#L1-L50)

## 核心数据类型

### 游戏时代枚举 (Era)

游戏包含八个不同的时代阶段，每个时代代表技术和社会发展的不同阶段：

```typescript
export const Era = {
  STONE: 'stone',
  BRONZE: 'bronze',
  IRON: 'iron',
  INDUSTRIAL: 'industrial',
  INFORMATION: 'information',
  SPACE: 'space',
  INTERSTELLAR: 'interstellar',
  HYPERDIMENSIONAL: 'hyperdimensional'
} as const

export type Era = typeof Era[keyof typeof Era]
```

**时代特性：**
- **石器时代**：基础生存资源（食物、木材、石头）
- **青铜时代**：中级资源（铜矿、黏土）和农业发展
- **铁器时代**：铁矿和煤炭，人口增长
- **工业时代**：钢铁、石油和电力，工业化进程
- **信息时代**：芯片和数据，信息技术革命
- **太空时代**：火箭燃料、合金和氦-3，太空探索
- **星际时代**：反物质、暗物质，星际旅行
- **超维时代**：量子能量、时空晶体，维度技术

### 资源类型系统

```mermaid
classDiagram
class Resource {
+ResourceType id
+string name
+string description
+string icon
+string category
+Era era
+number baseStorage
}
class ResourceType {
<<enumeration>>
food
wood
stone
copper
iron
coal
steel
oil
electricity
chip
data
rocketFuel
alloy
helium3
antimatter
darkMatter
quantumEnergy
spacetimeCrystal
gold
knowledge
culture
prestige
}
class ResourceAmount {
<<type alias>>
Partial~Record~ResourceType,number~~
}
Resource --> ResourceType : "uses"
ResourceAmount --> ResourceType : "maps"
```

**图表来源**
- [index.ts](file://civilization-game/src/types/index.ts#L10-L30)
- [index.ts](file://civilization-game/src/types/index.ts#L32-L45)

### 建筑系统架构

```mermaid
classDiagram
class Building {
+string id
+string name
+string description
+string icon
+BuildingType type
+Era era
+number level
+number maxLevel
+ResourceAmount buildCost
+number upgradeCostMultiplier
+number buildTime
+number upgradeTime
+ResourceAmount production
+ResourceAmount consumption
+ResourceAmount capacity
+number population
+Requirement[] requirements
+Effect[] effects
}
class BuildingInstance {
+string buildingId
+number level
+BuildingStatus status
+number buildStartTime
+number upgradeStartTime
}
class BuildingType {
<<enumeration>>
PRODUCTION
STORAGE
POPULATION
TECHNOLOGY
FUNCTIONAL
SPECIAL
}
class BuildingStatus {
<<enumeration>>
LOCKED
AVAILABLE
BUILDING
BUILT
UPGRADING
}
Building --> BuildingType : "categorizes"
Building --> BuildingStatus : "tracks"
BuildingInstance --> Building : "instances"
```

**图表来源**
- [index.ts](file://civilization-game/src/types/index.ts#L50-L85)
- [index.ts](file://civilization-game/src/types/index.ts#L87-L95)

### 科技树系统

```mermaid
classDiagram
class Technology {
+string id
+string name
+string description
+string icon
+Era era
+string category
+ResourceAmount researchCost
+number researchTime
+string[] prerequisites
+Effect[] effects
+string[] unlocks
}
class TechnologyInstance {
+string technologyId
+TechnologyStatus status
+number researchStartTime
+number researchProgress
}
class TechnologyStatus {
<<enumeration>>
LOCKED
AVAILABLE
RESEARCHING
RESEARCHED
}
Technology --> TechnologyStatus : "tracks"
TechnologyInstance --> Technology : "instances"
```

**图表来源**
- [index.ts](file://civilization-game/src/types/index.ts#L100-L125)
- [index.ts](file://civilization-game/src/types/index.ts#L127-L135)

**章节来源**
- [index.ts](file://civilization-game/src/types/index.ts#L1-L198)

## 游戏状态管理

### GameState 接口设计

```mermaid
classDiagram
class GameState {
+Era currentEra
+number gameTime
+number lastSaveTime
+number lastPlayTime
+Population population
}
class Population {
+number current
+number max
+number growthRate
}
GameState --> Population : "contains"
```

**图表来源**
- [index.ts](file://civilization-game/src/types/index.ts#L140-L155)
- [game.ts](file://civilization-game/src/stores/game.ts#L10-L25)

### 状态计算与更新

游戏状态通过Pinia store进行管理，提供了以下核心功能：

1. **实时时间更新**：每秒更新游戏时间，支持游戏速度调节
2. **人口动态管理**：根据当前人口和上限自动调整增长
3. **时代推进控制**：验证并执行时代切换逻辑
4. **事件系统集成**：支持状态变更事件通知

```typescript
// 游戏时间更新示例
function updateTime(deltaTime: number) {
  if (!isPaused.value) {
    gameTime.value += deltaTime * gameSpeed.value
  }
}

// 人口增长计算
function updatePopulationGrowth(deltaTime: number) {
  if (isPaused.value) return
  
  if (population.value.current < population.value.max) {
    const growth = population.value.growthRate * deltaTime
    population.value.current = Math.min(
      population.value.current + growth,
      population.value.max
    )
  }
}
```

**章节来源**
- [game.ts](file://civilization-game/src/stores/game.ts#L50-L100)

## 存档系统设计

### SaveData 结构分析

```mermaid
classDiagram
class SaveData {
+string version
+number createdAt
+number lastSaved
+GameState gameState
+Record~ResourceType,number~ resources
+BuildingInstance[] buildings
+TechnologyInstance[] technologies
+AchievementInstance[] achievements
}
class CompressedSave {
+string v
+number c
+number l
+CompressedGameState g
+Object r
+Array b
+Array t
+Array a
}
SaveData --> CompressedSave : "compresses to"
```

**图表来源**
- [index.ts](file://civilization-game/src/types/index.ts#L160-L175)
- [save.ts](file://civilization-game/src/stores/save.ts#L20-L60)

### 版本控制与兼容性

存档系统实现了完善的版本控制机制：

```typescript
// 版本检查逻辑
if (saveData.version !== GAME_VERSION) {
  console.warn('存档版本不匹配,可能需要迁移')
}

// 自动迁移策略
function migrateSaveData(oldVersion: string, newData: SaveData): SaveData {
  // 版本迁移逻辑
  // 处理字段添加、删除或重命名
  // 保持向后兼容性
}
```

### 压缩优化策略

```mermaid
flowchart TD
OriginalData["原始存档数据"] --> FilterSmallValues["过滤极小值<br/>(< 0.01)"]
FilterSmallValues --> RoundDecimals["舍入小数<br/>(1位小数)"]
RoundDecimals --> CompressKeys["压缩键名<br/>(v,c,l,g,r,b,t,a)"]
CompressKeys --> Stringify["JSON序列化"]
Stringify --> CompressedData["压缩存档数据"]
CompressedData --> Decompress["解压过程"]
Decompress --> RestoreKeys["恢复键名"]
RestoreKeys --> RestoreValues["还原数值"]
RestoreValues --> OriginalData
```

**图表来源**
- [save.ts](file://civilization-game/src/stores/save.ts#L20-L60)

**章节来源**
- [save.ts](file://civilization-game/src/stores/save.ts#L1-L100)

## 大数字处理策略

### 数字格式化系统

```mermaid
flowchart TD
NumberInput["输入数字"] --> CheckZero{"是否为0?"}
CheckZero --> |是| ZeroOutput["返回'0'"]
CheckZero --> |否| CheckRange{"数值范围"}
CheckRange --> Less1000{"< 1000?"}
Less1000 --> |是| DirectDisplay["直接显示<br/>(整数或保留小数)"]
Less1000 --> |否| CheckSuffix{"查找单位后缀"}
CheckSuffix --> HasSuffix{"存在后缀?"}
HasSuffix --> |是| FormatWithSuffix["格式化+后缀<br/>(K,M,B,T...)"]
HasSuffix --> |否| ScientificNotation["科学计数法"]
ZeroOutput --> Output["输出结果"]
DirectDisplay --> Output
FormatWithSuffix --> Output
ScientificNotation --> Output
```

**图表来源**
- [formatNumber.ts](file://civilization-game/src/utils/formatNumber.ts#L10-L40)

### 格式化函数实现

系统提供了多种数字格式化方法：

```typescript
// 主要格式化函数
export function formatNumber(value: number, decimals: number = 2): string {
  if (value === 0) return '0'
  if (value < 0) return '-' + formatNumber(-value, decimals)
  
  // 小于1000直接显示
  if (value < 1000) {
    return value % 1 === 0 ? value.toString() : value.toFixed(decimals)
  }
  
  // 使用单位后缀
  const suffixes = ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No', 'Dc']
  const tier = Math.floor(Math.log10(value) / 3)
  
  if (tier < suffixes.length) {
    const suffix = suffixes[tier]
    const scale = Math.pow(10, tier * 3)
    const scaled = value / scale
    return scaled.toFixed(decimals) + suffix
  }
  
  // 超大数字使用科学计数法
  return value.toExponential(decimals)
}
```

### 精度处理策略

1. **浮点数精度问题**：使用适当的舍入策略避免显示误差
2. **大数显示优化**：自动选择合适的表示方式
3. **性能考虑**：对频繁显示的数值使用缓存机制

**章节来源**
- [formatNumber.ts](file://civilization-game/src/utils/formatNumber.ts#L1-L120)

## 类型安全与架构优势

### 类型系统设计原则

```mermaid
graph LR
StrongTypes["强类型系统"] --> CompileTime["编译时检查"]
CompileTime --> Runtime["运行时安全"]
Runtime --> Maintainability["代码可维护性"]
TypeSafety["类型安全性"] --> IntelliSense["智能提示"]
IntelliSense --> Refactoring["重构安全"]
Refactoring --> Documentation["自文档化"]
DesignPatterns["设计模式"] --> Composition["组合优于继承"]
Composition --> Immutability["不可变数据"]
Immutability --> Predictability["行为可预测"]
```

### 枚举类型的优势

1. **值域限制**：确保只能使用预定义的有效值
2. **自动补全**：IDE提供完整的选项建议
3. **编译时验证**：防止拼写错误和无效值
4. **文档化**：类型定义本身就是良好的文档

```typescript
// 示例：有效的枚举使用
const validEra: Era = Era.STONE // ✅ 正确
const invalidEra: Era = 'invalid' // ❌ 编译错误

// 类型保护
function isValidEra(era: string): era is Era {
  return Object.values(Era).includes(era as Era)
}
```

### 接口继承与扩展

```mermaid
classDiagram
class BaseInterface {
<<interface>>
+string id
+string name
+string description
}
class Resource {
+ResourceType id
+string name
+string description
+string icon
+string category
+Era era
+number baseStorage
}
class Building {
+string id
+string name
+string description
+string icon
+BuildingType type
+Era era
+number level
+ResourceAmount buildCost
+Requirement[] requirements
}
BaseInterface <|-- Resource : "extends"
BaseInterface <|-- Building : "extends"
```

**图表来源**
- [index.ts](file://civilization-game/src/types/index.ts#L32-L45)
- [index.ts](file://civilization-game/src/types/index.ts#L50-L85)

**章节来源**
- [index.ts](file://civilization-game/src/types/index.ts#L1-L198)

## 性能优化考虑

### 内存管理策略

1. **对象池模式**：重用频繁创建的对象实例
2. **懒加载**：按需加载大型配置数据
3. **弱引用**：避免内存泄漏
4. **批量更新**：合并多个状态变更操作

### 计算属性优化

```typescript
// Vue计算属性的缓存机制
const formattedGameTime = computed(() => {
  const hours = Math.floor(gameTime.value / 3600)
  const minutes = Math.floor((gameTime.value % 3600) / 60)
  const seconds = Math.floor(gameTime.value % 60)
  return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
})
```

### 存档压缩算法

```mermaid
sequenceDiagram
participant Store as "状态管理器"
participant Compressor as "压缩器"
participant Storage as "本地存储"
Store->>Compressor : 原始数据
Compressor->>Compressor : 过滤小值
Compressor->>Compressor : 舍入精度
Compressor->>Compressor : 压缩键名
Compressor->>Compressor : JSON序列化
Compressor->>Storage : 压缩数据
Storage-->>Store : 存储确认
```

**图表来源**
- [save.ts](file://civilization-game/src/stores/save.ts#L20-L60)

## 故障排除指南

### 常见类型错误

1. **枚举值错误**
   ```typescript
   // 错误：使用了不存在的枚举值
   const era: Era = 'future' // ❌ 编译错误
   
   // 正确：使用有效枚举值
   const era: Era = Era.INDUSTRIAL // ✅ 正确
   ```

2. **类型不匹配**
   ```typescript
   // 错误：类型不兼容
   const resources: ResourceAmount = { food: '100' } // ❌ number期望
   
   // 正确：使用正确的类型
   const resources: ResourceAmount = { food: 100 } // ✅ 正确
   ```

3. **可选属性访问**
   ```typescript
   // 安全的可选属性访问
   const production = building.production ?? {}
   const totalProduction = Object.values(production).reduce((sum, val) => sum + (val || 0), 0)
   ```

### 存档问题诊断

```mermaid
flowchart TD
LoadError["加载失败"] --> CheckVersion{"版本检查"}
CheckVersion --> |版本不匹配| MigrationNeeded["需要迁移"]
CheckVersion --> |版本匹配| CheckCorruption{"数据完整性"}
CheckCorruption --> |损坏| ResetData["重置数据"]
CheckCorruption --> |正常| CheckStructure{"结构验证"}
CheckStructure --> |结构错误| RepairStructure["修复结构"]
CheckStructure --> |结构正确| CheckConsistency{"一致性检查"}
CheckConsistency --> |不一致| ResolveConflict["解决冲突"]
CheckConsistency --> |一致| Success["加载成功"]
MigrationNeeded --> BackupOld["备份旧存档"]
BackupOld --> MigrateData["执行迁移"]
MigrateData --> Success
ResetData --> Success
RepairStructure --> Success
ResolveConflict --> Success
```

**章节来源**
- [save.ts](file://civilization-game/src/stores/save.ts#L100-L150)

## 总结

该文明游戏的数据模型系统展现了现代TypeScript应用的最佳实践：

### 核心优势

1. **类型安全**：通过严格的类型定义确保代码质量
2. **模块化设计**：清晰的职责分离和依赖关系
3. **性能优化**：智能的缓存和压缩策略
4. **可扩展性**：易于添加新的资源、建筑和科技
5. **向后兼容**：完善的版本控制和迁移机制

### 技术亮点

- **枚举类型**：提供值域限制和自动补全
- **接口继承**：实现类型安全的扩展机制
- **计算属性**：Vue响应式系统的高效利用
- **存档压缩**：平衡存储空间和性能的优化方案
- **大数处理**：优雅的数字格式化解决方案

### 发展方向

1. **性能监控**：添加内存使用和性能指标
2. **类型扩展**：支持更多游戏机制的类型定义
3. **工具增强**：开发更多的类型辅助工具
4. **测试覆盖**：完善类型相关的单元测试

这套数据模型不仅为当前的游戏功能提供了坚实的基础，也为未来的功能扩展和性能优化奠定了良好的架构基础。