# 核心架构文档

<cite>
**本文档引用的文件**
- [main.ts](file://civilization-game/src/main.ts)
- [App.vue](file://civilization-game/src/App.vue)
- [MainLayout.vue](file://civilization-game/src/components/game/MainLayout.vue)
- [useGameEngine.ts](file://civilization-game/src/composables/useGameEngine.ts)
- [game.ts](file://civilization-game/src/stores/game.ts)
- [constants.ts](file://civilization-game/src/config/constants.ts)
- [index.ts](file://civilization-game/src/types/index.ts)
- [GameButton.vue](file://civilization-game/src/components/ui/GameButton.vue)
</cite>

## 目录
1. [项目概述](#项目概述)
2. [项目结构分析](#项目结构分析)
3. [应用入口与初始化](#应用入口与初始化)
4. [MVVM架构模式](#mvvm架构模式)
5. [组件层次结构](#组件层次结构)
6. [状态管理系统](#状态管理系统)
7. [游戏引擎架构](#游戏引擎架构)
8. [设计原则与可维护性](#设计原则与可维护性)
9. [总结](#总结)

## 项目概述

这是一个基于Vue 3和TypeScript构建的文明发展模拟游戏，采用现代化前端架构模式。项目展现了清晰的分层架构，通过MVVM模式实现了视图、模型和视图模型的有效分离，同时利用Pinia进行状态管理，确保了代码的可维护性和扩展性。

## 项目结构分析

```mermaid
graph TB
subgraph "项目根目录"
Root[civilization-game/]
end
subgraph "源码目录 (src/)"
Src[src/]
Components[components/]
Stores[stores/]
Composables[composables/]
Config[config/]
Types[types/]
Utils[utils/]
App[App.vue]
Main[main.ts]
end
subgraph "组件层"
GameComponents[game/]
UIComponents[ui/]
Layout[MainLayout.vue]
GameEngine[useGameEngine.ts]
end
subgraph "状态管理层"
GameStore[game.ts]
ResourceStore[resource.ts]
BuildingStore[building.ts]
TechStore[tech.ts]
AchievementStore[achievement.ts]
SaveStore[save.ts]
end
Root --> Src
Src --> Components
Src --> Stores
Src --> Composables
Src --> Config
Src --> Types
Src --> Utils
Src --> App
Src --> Main
Components --> GameComponents
Components --> UIComponents
GameComponents --> Layout
Composables --> GameEngine
Stores --> GameStore
Stores --> ResourceStore
Stores --> BuildingStore
Stores --> TechStore
Stores --> AchievementStore
Stores --> SaveStore
```

**图表来源**
- [main.ts](file://civilization-game/src/main.ts#L1-L13)
- [App.vue](file://civilization-game/src/App.vue#L1-L101)

**章节来源**
- [main.ts](file://civilization-game/src/main.ts#L1-L13)
- [App.vue](file://civilization-game/src/App.vue#L1-L101)

## 应用入口与初始化

### main.ts - 应用启动核心

应用的启动过程遵循标准的Vue 3应用程序初始化模式：

```typescript
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import '@unocss/reset/tailwind.css'
import 'uno.css'
import './style.css'
import App from './App.vue'

const app = createApp(App)
const pinia = createPinia()

app.use(pinia)
app.mount('#app')
```

这个简洁的启动文件展示了现代前端应用的最佳实践：
- **模块化导入**：按需导入必要的依赖
- **CSS预处理**：集成了UnoCSS和Tailwind CSS重置样式
- **状态管理集成**：Pinia作为状态管理解决方案
- **渐进式增强**：支持CSS重置和自定义样式

### App.vue - 应用根组件

App.vue作为整个应用的根组件，承担着协调各个子系统的重要职责：

```mermaid
sequenceDiagram
participant Browser as 浏览器
participant App as App.vue
participant GameEngine as useGameEngine
participant Stores as Pinia Stores
participant SaveStore as Save Store
Browser->>App : 页面加载
App->>SaveStore : 检查存档
alt 存档存在
App->>SaveStore : 加载存档
else 新游戏
App->>Stores : 初始化资源
App->>Stores : 初始化科技
App->>Stores : 初始化成就
end
App->>Stores : 启动游戏
App->>GameEngine : 启动游戏引擎
App->>App : 启动自动保存定时器
Note over App : 游戏运行中...
Browser->>App : 页面卸载
App->>SaveStore : 保存游戏
App->>GameEngine : 停止游戏引擎
```

**图表来源**
- [App.vue](file://civilization-game/src/App.vue#L25-L55)
- [useGameEngine.ts](file://civilization-game/src/composables/useGameEngine.ts#L100-L120)

**章节来源**
- [main.ts](file://civilization-game/src/main.ts#L1-L13)
- [App.vue](file://civilization-game/src/App.vue#L1-L101)

## MVVM架构模式

### 视图层 (View) - Vue组件

项目采用了高度模块化的组件架构，每个组件都有明确的职责边界：

```mermaid
classDiagram
class App {
+onMounted()
+onUnmounted()
-autoSaveInterval : number
+loadGame()
+initializeGame()
}
class MainLayout {
+activeView : string
+mobileMenuOpen : boolean
+menuItems : MenuItem[]
+toggleMobileMenu()
+selectMenuItem()
}
class GameButton {
+variant : string
+size : string
+disabled : boolean
+loading : boolean
+handleClick()
}
class ResourcePanel {
+resources : Resource[]
+getResourceDisplay()
}
class BuildingPanel {
+buildings : Building[]
+selectedBuilding : Building
+buildBuilding()
}
App --> MainLayout : "渲染"
MainLayout --> GameButton : "使用"
MainLayout --> ResourcePanel : "包含"
MainLayout --> BuildingPanel : "包含"
GameButton --> App : "事件回调"
```

**图表来源**
- [App.vue](file://civilization-game/src/App.vue#L1-L20)
- [MainLayout.vue](file://civilization-game/src/components/game/MainLayout.vue#L150-L200)
- [GameButton.vue](file://civilization-game/src/components/ui/GameButton.vue#L1-L30)

### 模型层 (Model) - Pinia Stores

Pinia stores作为数据模型层，提供了响应式的状态管理：

```mermaid
classDiagram
class GameStore {
+currentEra : Era
+gameTime : number
+population : Population
+isPaused : boolean
+gameSpeed : number
+startGame()
+pauseGame()
+updateTime()
+advanceEra()
}
class ResourceStore {
+resources : ResourceMap
+getResourceAmount()
+addResource()
+consumeResource()
+updateResources()
}
class BuildingStore {
+buildings : BuildingInstance[]
+getAvailableBuildings()
+buildBuilding()
+upgradeBuilding()
+updateBuildingProgress()
}
class TechStore {
+technologies : TechnologyInstance[]
+researchTech()
+updateResearchProgress()
+canResearchTech()
}
class AchievementStore {
+achievements : AchievementInstance[]
+checkAchievements()
+unlockAchievement()
}
GameStore --> ResourceStore : "依赖"
GameStore --> BuildingStore : "依赖"
GameStore --> TechStore : "依赖"
GameStore --> AchievementStore : "依赖"
```

**图表来源**
- [game.ts](file://civilization-game/src/stores/game.ts#L1-L50)
- [useGameEngine.ts](file://civilization-game/src/composables/useGameEngine.ts#L10-L20)

### 视图模型层 (ViewModel) - 组合式函数

useGameEngine作为核心的组合式函数，封装了游戏逻辑：

```mermaid
flowchart TD
Start([游戏引擎启动]) --> InitVars["初始化变量<br/>- animationFrameId<br/>- lastUpdateTime<br/>- accumulator"]
InitVars --> GameLoop["游戏循环<br/>requestAnimationFrame"]
GameLoop --> CalcDelta["计算时间差<br/>deltaTime"]
CalcDelta --> UpdateAccumulator["更新累加器<br/>accumulator += deltaTime"]
UpdateAccumulator --> CheckFPS["检查FPS<br/>frameCount++"]
CheckFPS --> CheckLimit{"累加器超限?"}
CheckLimit --> |是| LogWarning["记录警告<br/>帧跳过"]
CheckLimit --> |否| UpdateLogic["更新游戏逻辑<br/>while(accumulator >= GAME_TICK_INTERVAL)"]
LogWarning --> UpdateLogic
UpdateLogic --> ConsumeTime["消耗时间<br/>accumulator -= GAME_TICK_INTERVAL"]
ConsumeTime --> RequestFrame["请求下一帧<br/>requestAnimationFrame"]
RequestFrame --> GameLoop
UpdateLogic --> UpdateGame["updateGame()<br/>- 更新游戏时间<br/>- 更新资源<br/>- 更新人口<br/>- 更新建筑<br/>- 更新科技<br/>- 检查成就"]
```

**图表来源**
- [useGameEngine.ts](file://civilization-game/src/composables/useGameEngine.ts#L25-L80)

**章节来源**
- [App.vue](file://civilization-game/src/App.vue#L1-L101)
- [useGameEngine.ts](file://civilization-game/src/composables/useGameEngine.ts#L1-L143)
- [game.ts](file://civilization-game/src/stores/game.ts#L1-L199)

## 组件层次结构

### 主布局组件 MainLayout

MainLayout是整个游戏界面的核心容器，负责协调各个功能模块：

```mermaid
graph TB
subgraph "MainLayout.vue"
Header[头部导航栏]
Sidebar[左侧菜单栏]
MobileMenu[移动端菜单]
Content[内容区域]
Footer[底部导航栏]
end
subgraph "内容面板"
Overview[概览面板]
Buildings[建筑面板]
Technology[科技树]
Achievements[成就面板]
Stats[统计面板]
end
subgraph "通用组件"
EraIndicator[时代指示器]
ResourcePanel[资源面板]
BuildingCard[建筑卡片]
TechNode[科技节点]
AchievementNotification[成就通知]
end
Header --> Sidebar
Header --> MobileMenu
Sidebar --> Content
MobileMenu --> Content
Content --> Overview
Content --> Buildings
Content --> Technology
Content --> Achievements
Content --> Stats
Overview --> EraIndicator
Overview --> ResourcePanel
Buildings --> BuildingCard
Technology --> TechNode
Achievements --> AchievementNotification
```

**图表来源**
- [MainLayout.vue](file://civilization-game/src/components/game/MainLayout.vue#L1-L100)

### 响应式布局设计

项目采用了移动优先的响应式设计策略：

- **桌面端**：固定侧边栏菜单，最大化内容显示空间
- **移动端**：抽屉式菜单，底部导航栏，优化触摸交互
- **断点适配**：768px断点用于区分移动设备和平板设备

**章节来源**
- [MainLayout.vue](file://civilization-game/src/components/game/MainLayout.vue#L1-L275)

## 状态管理系统

### Pinia Store架构

项目采用单一状态树设计，所有游戏状态都集中管理：

```mermaid
graph LR
subgraph "核心状态"
Game[游戏状态<br/>game.ts]
Resources[资源状态<br/>resource.ts]
Buildings[建筑状态<br/>building.ts]
Tech[科技状态<br/>tech.ts]
Achievements[成就状态<br/>achievement.ts]
Save[存档状态<br/>save.ts]
end
subgraph "计算属性"
FormattedTime[格式化游戏时间]
CurrentEra[当前时代名称]
AvailableBuildings[可用建筑列表]
ResearchableTech[可研究科技]
end
Game --> FormattedTime
Game --> CurrentEra
Buildings --> AvailableBuildings
Tech --> ResearchableTech
Game -.->|事件通信| Achievements
Resources -.->|资源变化| Buildings
Tech -.->|解锁| Buildings
```

**图表来源**
- [game.ts](file://civilization-game/src/stores/game.ts#L1-L100)
- [constants.ts](file://civilization-game/src/config/constants.ts#L1-L61)

### 状态持久化机制

项目实现了完整的状态持久化系统：

```mermaid
sequenceDiagram
participant User as 用户操作
participant App as App.vue
participant SaveStore as Save Store
participant LocalStorage as 本地存储
User->>App : 页面加载
App->>SaveStore : hasSave()
SaveStore->>LocalStorage : getItem(STORAGE_KEYS.saveData)
LocalStorage-->>SaveStore : 存档数据或null
SaveStore-->>App : 返回存档状态
alt 存档存在
App->>SaveStore : loadGame()
SaveStore->>SaveStore : 解析存档数据
SaveStore->>GameStore : loadGameState()
SaveStore->>ResourceStore : loadResources()
SaveStore->>BuildingStore : loadBuildings()
else 新游戏
App->>ResourceStore : initializeResources()
App->>TechStore : initializeTechs()
App->>AchievementStore : initializeAchievements()
end
User->>App : 页面卸载
App->>SaveStore : saveGame()
SaveStore->>SaveStore : 生成存档数据
SaveStore->>LocalStorage : setItem(saveData)
```

**图表来源**
- [App.vue](file://civilization-game/src/App.vue#L25-L45)
- [constants.ts](file://civilization-game/src/config/constants.ts#L45-L50)

**章节来源**
- [game.ts](file://civilization-game/src/stores/game.ts#L1-L199)
- [App.vue](file://civilization-game/src/App.vue#L25-L55)

## 游戏引擎架构

### 实时游戏循环系统

useGameEngine实现了高性能的游戏循环系统：

```mermaid
flowchart TD
Start([启动游戏引擎]) --> RAF["requestAnimationFrame(gameLoop)"]
RAF --> GetTime["获取当前时间"]
GetTime --> CalcDelta["计算时间差<br/>deltaTime = currentTime - lastUpdateTime"]
CalcDelta --> UpdateFPS["更新FPS计数<br/>frameCount++"]
UpdateFPS --> CheckFPS{"FPS < 50?"}
CheckFPS --> |是| WarnFPS["记录低FPS警告"]
CheckFPS --> |否| UpdateAccumulator["更新累加器<br/>accumulator += deltaTime"]
WarnFPS --> UpdateAccumulator
UpdateAccumulator --> CheckAccumulator{"累加器 > 3000ms?"}
CheckAccumulator --> |是| LogSkip["记录帧跳过警告"]
CheckAccumulator --> |否| UpdateLogic["更新游戏逻辑"]
LogSkip --> UpdateLogic
UpdateLogic --> CheckAccumulator2{"accumulator >= GAME_TICK_INTERVAL?"}
CheckAccumulator2 --> |是| CallUpdate["调用updateGame(1)<br/>更新1秒"]
CheckAccumulator2 --> |否| RequestFrame["requestAnimationFrame"]
CallUpdate --> SubTime["accumulator -= GAME_TICK_INTERVAL"]
SubTime --> CheckAccumulator2
RequestFrame --> RAF
```

**图表来源**
- [useGameEngine.ts](file://civilization-game/src/composables/useGameEngine.ts#L25-L80)

### 游戏逻辑更新流程

```mermaid
sequenceDiagram
participant Engine as 游戏引擎
participant GameStore as 游戏状态
participant ResourceStore as 资源管理
participant BuildingStore as 建筑管理
participant TechStore as 科技管理
participant AchievementStore as 成就系统
loop 每秒更新
Engine->>GameStore : updateTime(deltaTime)
Engine->>ResourceStore : updateResources(deltaTime)
Engine->>GameStore : updatePopulationGrowth(deltaTime)
Engine->>BuildingStore : updateBuildingProgress()
Engine->>TechStore : updateResearchProgress()
Note over Engine : 每10秒检查一次成就
Engine->>AchievementStore : checkAchievements()
end
```

**图表来源**
- [useGameEngine.ts](file://civilization-game/src/composables/useGameEngine.ts#L50-L80)

**章节来源**
- [useGameEngine.ts](file://civilization-game/src/composables/useGameEngine.ts#L1-L143)

## 设计原则与可维护性

### 类型安全设计

项目充分利用TypeScript的强大类型系统：

```typescript
// 类型定义示例
export interface Building {
  id: string
  name: string
  description: string
  icon: string
  type: BuildingType
  era: Era
  level: number
  maxLevel: number
  buildCost: ResourceAmount
  production?: ResourceAmount
  consumption?: ResourceAmount
  capacity?: ResourceAmount
  population?: number
  requirements: Requirement[]
  effects?: Effect[]
}
```

### 配置驱动开发

项目采用配置文件管理游戏常量和规则：

```typescript
// 常量配置示例
export const GAME_TICK_INTERVAL = 1000 // 游戏循环间隔
export const AUTO_SAVE_INTERVAL = 30000 // 自动保存间隔
export const POPULATION = {
  baseGrowthRate: 1 / 60,
  foodConsumptionPerPop: 0.5,
  initialPopulation: 10,
  initialMaxPopulation: 20
}
```

### 模块化架构优势

1. **高内聚低耦合**：每个模块职责单一，便于维护和测试
2. **可扩展性**：新增功能只需添加新的store或组件
3. **类型安全**：编译时错误检查，减少运行时问题
4. **开发效率**：清晰的目录结构和命名规范

**章节来源**
- [constants.ts](file://civilization-game/src/config/constants.ts#L1-L61)
- [index.ts](file://civilization-game/src/types/index.ts#L1-L198)

## 总结

本项目展现了现代前端开发的最佳实践，通过以下关键特性实现了高质量的架构设计：

### 技术亮点

1. **现代化框架选择**：Vue 3 + TypeScript + Pinia的完美组合
2. **清晰的架构分层**：MVVM模式的完整实现
3. **高性能游戏引擎**：基于requestAnimationFrame的实时循环
4. **完善的类型系统**：全面的TypeScript类型定义
5. **响应式设计**：移动端优先的适配方案

### 架构优势

- **可维护性**：模块化设计，职责分离明确
- **可扩展性**：易于添加新功能和新组件
- **可测试性**：清晰的依赖关系，便于单元测试
- **用户体验**：流畅的动画效果和响应式交互

### 发展方向

该项目为未来的功能扩展奠定了坚实基础，可以轻松添加：
- 更多游戏时代和科技树
- 社交功能和多人协作
- 更丰富的UI组件和动画效果
- 跨平台部署支持

这种架构设计不仅保证了当前功能的稳定运行，也为未来的发展提供了无限可能。